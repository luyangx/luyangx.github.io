<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Multithreading | 扬</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://luyang87.gitee.io/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">扬</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">About</a>
  
    <a class="color-link nav-link" href="/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://luyang87.gitee.io/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="0xd1ef@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="https://twitter.com/luyangx" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://weibo.com/0xd1ef" target="_blank" rel="noopener" title="Weibo">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M11.7643305,23.68043 C16.3966564,23.2245381 19.9124334,20.3848721 19.6072176,17.3404411 C19.3097287,14.2998735 15.3071519,12.2019978 10.6709625,12.6617533 C6.03863666,13.1215087 2.52285972,15.9573112 2.82421203,19.0017422 C3.12556434,22.0423098 7.12814116,24.1401855 11.7643305,23.68043 Z M21.0328458,13.5774007 C22.6400581,14.075791 24.4288545,15.2812003 24.424991,17.4061204 C24.424991,20.9180339 19.3599541,25.3417312 11.7450131,25.3417312 C5.93818589,25.3417312 -2.23820962e-13,22.5252462 -2.23820962e-13,17.8967838 C-2.23820962e-13,15.4743748 1.53380598,12.6733438 4.17257044,10.0345793 C7.69993785,6.50721189 11.8145559,4.89999957 13.3599524,6.44925952 C14.0399268,7.13309745 14.1056062,8.31146225 13.6690317,9.72163652 C13.4372222,10.4286554 14.3335521,10.0384428 14.3335521,10.0384428 C17.1848086,8.84462403 19.6728969,8.77508119 20.5808173,10.0732142 C21.0676172,10.7686426 21.0212553,11.7383789 20.5730903,12.8626548 C20.3683253,13.3803626 20.6387697,13.4576325 21.0328458,13.5774007 Z M26.0901557,5.1047646 C27.9291775,7.14082443 28.4275678,9.91867457 27.6394156,12.3488105 C27.6394156,12.3488105 27.6394156,12.352674 27.6394156,12.352674 C27.4578316,12.9128802 26.8551269,13.2219595 26.2910572,13.0403754 C25.7269875,12.8587913 25.4179082,12.2560867 25.5994923,11.692017 C26.1596985,9.96117297 25.8042573,7.98692899 24.4983973,6.53811982 C23.1925373,5.08931064 21.2646553,4.5368314 19.4835858,4.91545354 C18.9040622,5.03908525 18.336129,4.67205359 18.2124973,4.09252992 C18.0888655,3.51686974 18.4558972,2.94507305 19.0354209,2.82144134 C21.5389631,2.28827956 24.2511339,3.06484128 26.0901557,5.1047646 Z M23.2659437,7.65466876 C24.1622736,8.64758598 24.4018101,9.99980788 24.0193244,11.1858997 C23.8609213,11.6726995 23.3432135,11.9354169 22.8564136,11.7808773 C22.3696137,11.6224742 22.1068963,11.1009029 22.261436,10.6179665 C22.450747,10.0384428 22.3309788,9.37778581 21.8944043,8.89098592 C21.4578298,8.40804953 20.8087633,8.22260195 20.2137857,8.35009716 C19.7192588,8.45827491 19.2285954,8.14146864 19.1204177,7.64307828 C19.0161034,7.14468793 19.3329097,6.65016106 19.8313,6.5458468 C21.0482998,6.2831294 22.3696137,6.66175153 23.2659437,7.65466876 Z M12.0193209,18.1710916 C12.1738606,17.8890568 12.0734098,17.576114 11.7952385,17.4756632 C11.5209306,17.3674855 11.1770799,17.4988442 11.0148133,17.7692886 C10.8564101,18.039733 10.9414069,18.3526757 11.2195783,18.464717 C11.4977496,18.5806217 11.8570543,18.449263 12.0193209,18.1710916 Z M10.5396038,20.0642023 C10.9800418,19.3417295 10.7482324,18.5188059 10.021896,18.2058631 C9.30328667,17.9045108 8.3760488,18.2135901 7.93174732,18.9090185 C7.48358235,19.6083104 7.69607436,20.438961 8.40695673,20.7634942 C9.12942957,21.091891 10.0914389,20.7789482 10.5396038,20.0642023 Z M12.224086,15.0030289 C14.5074092,15.5941431 15.6741836,17.7461076 14.7392187,19.8401198 C13.7926634,21.9766304 11.0727656,23.1202238 8.76239791,22.37457 C6.53702702,21.6559607 5.59047169,19.4537707 6.56793494,17.4717998 C7.52608075,15.5284637 10.0180325,14.4273687 12.224086,15.0030289 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://luyang87.gitee.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">Multithreading</h1>
    
    <time>April 15, 2016</time>
    
    <div>
        <p>
        <p>&laquo;C in a Nutshell&raquo;笔记 - 多线程</p>
<h2 id="threads">Threads</h2>
<p>当启动一个程序, 操作系统会为程序创建一个进程来运行它. 一个进程由一个或多个线程组成. 每个线程都是进程执行指令中的一部分</p>
<p>系统调度器分配给每个运行的线程的 CUP 时间是均等的. 一般 CUP 是抢占式(preemptive)的, 它会中断正在被某个CUP执行的 thread, 同时分配给其不同的一个 thread 执行. 即使在一个 CPU 的系统中, 用户都会感到程序是在并行执行的, 事实上在多个 CPU 系统中, 多个 thread 才能同时执行</p>
<p>每个进程在内存中都有自己的内存地址, 并且还有一些专有的资源, 例如打开的文件. 进程内部的 thread 贡献这些资源. 通常进程中的多个thread 贡献同样的地址空间. 这也使在进程中进行任务切换比不同的进程间简单</p>
<p>每个 thread 在任务切换中也有自己的所需资源, 包括栈内存, CPU 寄存器. 方便内存处理自己的数据, thread 也会有 线程指定 的永久内存</p>
<p>因为进程中的所有线程使用相同的地址空间, 贡献全局数据和静态数据. 意味这不同的 thread 可以并发访问相同的内存地址. 也就是容易发生 <em>data race</em> 或 <em>race condition</em>, 这就需要开发人员保证 thread 的数据同步</p>
<h1 id="creating-threads">Creating Threads</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">thrd_create</span>(thrd_t <span style="color:#f92672">*</span>thr, thrd_start_t func, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg);

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">thrd_join</span>(thrd_t thr, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>result);

    <span style="color:#75715e">// detach
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">thrd_detach</span>(thrdt thr);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;thread.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">#define MAX_THREADS 8
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#define MIN_BLOCK_SIZE 100
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
        <span style="color:#66d9ef">float</span> <span style="color:#f92672">*</span>start;   <span style="color:#75715e">// Start and length of the
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> len;        <span style="color:#75715e">// array block passed to parallel_sum()
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> block_size; <span style="color:#75715e">// Size of the smallest blocks
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">double</span> sum;     <span style="color:#75715e">// The result
</span><span style="color:#75715e"></span>    }

    <span style="color:#66d9ef">int</span> parallel_sum(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg);    <span style="color:#75715e">// Prototype of the thread function
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// ---------------------------------------------------------------
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Caculate the sum of array elements and write is to *sumPtr
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// sum() calls the function parallel_sum() for parallel processiong
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Return value: true if no error occurs; otherwise, false
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">sum</span>(<span style="color:#66d9ef">float</span> arr[], <span style="color:#66d9ef">int</span> len, <span style="color:#66d9ef">double</span><span style="color:#f92672">*</span> sumPtr) {
        <span style="color:#66d9ef">int</span> block_size <span style="color:#f92672">=</span> len <span style="color:#f92672">/</span> MAX_THREADS;
        <span style="color:#66d9ef">if</span> (block_size <span style="color:#f92672">&lt;</span> MIN_BLOCK_SIZE) {
            block_size <span style="color:#f92672">=</span> len;
        }

        Sum_arg args <span style="color:#f92672">=</span> { arr, len, block_size, <span style="color:#ae81ff">0.0</span> };
        <span style="color:#66d9ef">if</span> (parallel_sum(<span style="color:#f92672">&amp;</span>args)) {
            <span style="color:#f92672">*</span>sumPtr <span style="color:#f92672">=</span> arg.sum;
            <span style="color:#66d9ef">return</span> true;
        }

        <span style="color:#66d9ef">return</span> false;
    }

    <span style="color:#75715e">// ---------------------------------------------------------------
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Recursive helper function to divide the work among several threads
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">parallel_sum</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {
        Sum_arg <span style="color:#f92672">*</span>argp <span style="color:#f92672">=</span> (Sum_arg<span style="color:#f92672">*</span>) arg; <span style="color:#75715e">// A pointer to the arguments
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> (argp<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">&lt;=</span> argp<span style="color:#f92672">-&gt;</span>block_size) {    <span style="color:#75715e">// If lenght &lt;= block_size, add up the elements
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> argp<span style="color:#f92672">-&gt;</span>len; i<span style="color:#f92672">++</span>) {
                argp<span style="color:#f92672">-&gt;</span>sum <span style="color:#f92672">+=</span> argp<span style="color:#f92672">-&gt;</span>start[i];
            }

            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#66d9ef">int</span> mid <span style="color:#f92672">=</span> argp<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
            Sum_arg arg2 <span style="color:#f92672">=</span> {    <span style="color:#75715e">// Specifies second half
</span><span style="color:#75715e"></span>                argp<span style="color:#f92672">-&gt;</span>start <span style="color:#f92672">+</span> mid,
                argp<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">-</span> mid,
                argp<span style="color:#f92672">-&gt;</span>block_size,
                <span style="color:#ae81ff">0</span>
            };
            argp<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">=</span> mid;    <span style="color:#75715e">// Length of first half
</span><span style="color:#75715e"></span>
            thrd_t th;
            <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
            <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>th, parallel_sum, arg) <span style="color:#f92672">!=</span> thrd_success) {
                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
            }

            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>parallel_sum(<span style="color:#f92672">&amp;</span>arg2)) { <span style="color:#75715e">// Process second half by recursion in the current thread
</span><span style="color:#75715e"></span>                thrd_detch(th);
                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
            }

            thrd_join(th, <span style="color:#f92672">&amp;</span>res);
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>res) {
                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;   <span style="color:#75715e">// Sibling thread reported failure
</span><span style="color:#75715e"></span>            }

            argp<span style="color:#f92672">-&gt;</span>sum <span style="color:#f92672">+=</span> arg2.sum;
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
        }
    }
</code></pre></div><h2 id="accessing-shared-data">Accessing Shared Data</h2>
<p>如果多个 thread 访问相同的共享数据, 其中有一个 thread 修改了该数据, 为了防止 data race, 共享数据必须在其他 thread 中同步, 否则一个读的 thread 可以中断一个正在写的 thread, 因为程序执行时系统每次调度 thread 会不同</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;threads.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">#define COUNT 1000000L
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">long</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">incFunc</span>(<span style="color:#66d9ef">void</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">long</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> COUNT; <span style="color:#f92672">++</span>i) {
            <span style="color:#f92672">++</span>counter;
        }
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decFunc</span>(<span style="color:#66d9ef">void</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">long</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> COUNT; <span style="color:#f92672">++</span>i) {
            <span style="color:#f92672">--</span>counter;
        }
    }

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
        clock_t cl <span style="color:#f92672">=</span> clock();
        thrd_t th1, th2;
        <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>th1, (thrd_start_t)incFunc, NULL) <span style="color:#f92672">!=</span> thrd_success) {
            fprintf(stderr, <span style="color:#e6db74">&#34;Error creating thread</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }
        <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>th2, (thrd_start_t)incFunc, NULL) <span style="color:#f92672">!=</span> thrd_success) {
            fprintf(stderr, <span style="color:#e6db74">&#34;Error creating thread</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }

        thrd_join(th1, NULL);
        thrd_join(th2, NULL);

        printf(<span style="color:#e6db74">&#34;Counter: %ld </span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, counter);
        printf(<span style="color:#e6db74">&#34;CPU time: %ld ms</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (clock() <span style="color:#f92672">-</span> cl) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">/</span> CLOCKS_PER_SEC);

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    }
</code></pre></div><p>上述执行结果 counter 应该为 0 , 但是实际输出为</p>
<pre><code>    Counter: -714573        CPU time: 59 ms
</code></pre><h3 id="mutual-exclusion-mutex">Mutual Exclusion Mutex</h3>
<p>用来防止多个 thread 同时访问共享资源. mutex 是一个控制资源单独访问权限对象. 与 condition variables 一起可以扩展同步权限控制</p>
<p>*<em>int mtx_int(mtx_t <em>mtx, int mutextype);</em></em>
创建一个指定 mutextype 的 mutex, 成功后, *mtx 保存新 mutex 的 ID, 返回 thrd_success
. mutextype包括 mtx_plain, mtx_timed, mtx_plain | mtx_recursive, mtx_timed | mtx_recursive</p>
<p>*<em>void destroy(mtx_t <em>mtx);</em></em></p>
<p>*<em>int mtx_lock(mtx_t <em>mtx);</em></em>
block thread 直到获取指定 mutex 的锁</p>
<p>*<em>int mtx_unlock(mtx_t <em>mtx);</em></em>
release mutex 锁, 在 release 前必须拥有 mutex 的锁</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;threads.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">#define COUNT 1000000L
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">long</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    mtx_t mtx;  <span style="color:#75715e">// A mutex for access to counter
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">incFunc</span>(<span style="color:#66d9ef">void</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">long</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> COUNT; <span style="color:#f92672">++</span>i) {
            mtx_lock(<span style="color:#f92672">&amp;</span>mtx);
            <span style="color:#f92672">++</span>counter;
            mtx_unlock(<span style="color:#f92672">&amp;</span>mtx);
        }
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decFunc</span>(<span style="color:#66d9ef">void</span>) {
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">long</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> COUNT; <span style="color:#f92672">++</span>i) {
            mtx_lock(<span style="color:#f92672">&amp;</span>mtx);
            <span style="color:#f92672">--</span>counter;
            mtx_unlock(<span style="color:#f92672">&amp;</span>mtx);
        }
    }

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
        <span style="color:#66d9ef">if</span> (mtx_init(<span style="color:#f92672">&amp;</span>mtx, mtx_plain) <span style="color:#f92672">!=</span> thrd_success) {
            fprintf(stderr, <span style="color:#e6db74">&#34;Error intializing the mutex.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }

        clock_t cl <span style="color:#f92672">=</span> clock();
        thrd_t th1, th2;
        <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>th1, (thrd_start_t)incFunc, NULL) <span style="color:#f92672">!=</span> thrd_success) {
            fprintf(stderr, <span style="color:#e6db74">&#34;Error creating thread</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }
        <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>th2, (thrd_start_t)incFunc, NULL) <span style="color:#f92672">!=</span> thrd_success) {
            fprintf(stderr, <span style="color:#e6db74">&#34;Error creating thread</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }

        thrd_join(th1, NULL);
        thrd_join(th2, NULL);

        printf(<span style="color:#e6db74">&#34;Counter: %ld </span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, counter);
        printf(<span style="color:#e6db74">&#34;CPU time: %ld ms</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (clock() <span style="color:#f92672">-</span> cl) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">/</span> CLOCKS_PER_SEC);

        mtx_destroy(<span style="color:#f92672">&amp;</span>mtx);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    }
</code></pre></div><h2 id="communication-between-threads-condition-variables">Communication Between Threads: Condition Variables</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    <span style="color:#75715e">/* ------------------------------------------------
</span><span style="color:#75715e">     * buffer.h
</span><span style="color:#75715e">     * Declarations for a thread-safe buffer
</span><span style="color:#75715e">     */</span>
    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;threads.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Buffer {
        <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>data;  <span style="color:#75715e">// Pointer to the array of data
</span><span style="color:#75715e"></span>        size_t size, count; <span style="color:#75715e">// Maximum and current numbers of elements
</span><span style="color:#75715e"></span>        size_t tip, tail;   <span style="color:#75715e">// tip = index of the next free spot
</span><span style="color:#75715e"></span>        mtx_t mtx;  <span style="color:#75715e">// A mutex and
</span><span style="color:#75715e"></span>        cnd_t cndPut, cndGet;   <span style="color:#75715e">// two condition variables
</span><span style="color:#75715e"></span>    } Buffer

    <span style="color:#66d9ef">bool</span> bufInit(Buffer <span style="color:#f92672">*</span>bufPtr, size_t size);
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bufDestroy</span>(Buffer <span style="color:#f92672">*</span>bufPtr);

    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">bufPut</span>(Buffer <span style="color:#f92672">*</span>bufPtr, <span style="color:#66d9ef">int</span> data);
    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">bufGet</span>(Buffer <span style="color:#f92672">*</span>bufPtr, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>dataPtr, <span style="color:#66d9ef">int</span> sec);

    <span style="color:#75715e">/* ------------------------------------------------
</span><span style="color:#75715e">     * buffer.c
</span><span style="color:#75715e">     * Definitions of functions operating on Buffer
</span><span style="color:#75715e">     */</span>
     <span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;buffer.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>     <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;    // For malloc() and free()</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
     <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">bufInit</span>(Buffer <span style="color:#f92672">*</span>bufPtr, size_t size) {
        <span style="color:#66d9ef">if</span> ((bufPtr<span style="color:#f92672">-&gt;</span>data <span style="color:#f92672">=</span> malloc(size <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>))) <span style="color:#f92672">==</span> NULL) {
            <span style="color:#66d9ef">return</span> false;
        }

        bufPtr<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">=</span> size;
        bufPtr<span style="color:#f92672">-&gt;</span>count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        bufPtr<span style="color:#f92672">-&gt;</span>tip <span style="color:#f92672">=</span> bufPtr<span style="color:#f92672">-&gt;</span>tail <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">return</span> mtx_init(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx, mtx_plain) <span style="color:#f92672">==</span> thrd_success
            <span style="color:#f92672">&amp;&amp;</span> cnd_init(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndPut) <span style="color:#f92672">==</span> thrd_success
            <span style="color:#f92672">&amp;&amp;</span> cnd_init(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndGet) <span style="color:#f92672">==</span> thrd_success;
     }

     <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bufDestroy</span>(Buffer <span style="color:#f92672">*</span>bufPtr) {
        cnd_destroy(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndPut);
        cnd_destroy(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndGet);

        mtx_destroy(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx);
        free(bufPtr<span style="color:#f92672">-&gt;</span>data);
     }

     <span style="color:#75715e">// Insert a new element in buffer
</span><span style="color:#75715e"></span>     <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">bufPut</span>(Buffer <span style="color:#f92672">*</span>bufPtr, <span style="color:#66d9ef">int</span> data) {
        mtx_lock(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx);
        <span style="color:#66d9ef">while</span> (bufPtr<span style="color:#f92672">-&gt;</span>count <span style="color:#f92672">==</span> bufPtr<span style="color:#f92672">-&gt;</span>size) {
            <span style="color:#66d9ef">if</span> (cnd_wait(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndPut, <span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx) <span style="color:#f92672">!=</span> thrd_success) {
                <span style="color:#66d9ef">return</span> false;
            }
        }

        bufPtr<span style="color:#f92672">-&gt;</span>data[bufPtr<span style="color:#f92672">-&gt;</span>tip] <span style="color:#f92672">=</span> data;
        bufPtr<span style="color:#f92672">-&gt;</span>tip <span style="color:#f92672">=</span> (bufPtr<span style="color:#f92672">-&gt;</span>tip <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> bufPtr<span style="color:#f92672">-&gt;</span>size;
        <span style="color:#f92672">++</span>bufPtr<span style="color:#f92672">-&gt;</span>count;

        mtx_unlock(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx);
        cnd_signal(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndGet);

        <span style="color:#66d9ef">return</span> true;
     }

     <span style="color:#75715e">// Remove an element from the buffer. If the buffer is empty, wait no more than sec seconds
</span><span style="color:#75715e"></span>     <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">bufGet</span>(Buffer <span style="color:#f92672">*</span>bufPtr, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>dataPtr, <span style="color:#66d9ef">int</span> sec) {
        <span style="color:#66d9ef">struct</span> timespec ts;
        timepec_get(<span style="color:#f92672">&amp;</span>ts, TIME_UTC); <span style="color:#75715e">// The current time + sec seconds delay
</span><span style="color:#75715e"></span>        ts.tv_sec <span style="color:#f92672">+=</span> sec;

        mtx_lock(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx);

        <span style="color:#66d9ef">while</span> (bufPtr<span style="color:#f92672">-&gt;</span>count <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#66d9ef">if</span> (cnd_timedwait(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndGet, <span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx, <span style="color:#f92672">&amp;</span>ts) <span style="color:#f92672">!=</span> thrd_success) {
                <span style="color:#66d9ef">return</span> false;
            }
        }

        <span style="color:#f92672">*</span>dataPtr <span style="color:#f92672">=</span> bufPtr<span style="color:#f92672">-&gt;</span>data[bufPtr<span style="color:#f92672">-&gt;</span>tail];
        bufPtr<span style="color:#f92672">-&gt;</span>tail <span style="color:#f92672">=</span> (bufPtr<span style="color:#f92672">-&gt;</span>tail <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> bufPtr<span style="color:#f92672">-&gt;</span>size;
        <span style="color:#f92672">--</span>bufPtr<span style="color:#f92672">-&gt;</span>count;

        mtx_unlock(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>mtx);
        cnd_signal(<span style="color:#f92672">&amp;</span>bufPtr<span style="color:#f92672">-&gt;</span>cndPut);

        <span style="color:#66d9ef">return</span> true;
     }

     <span style="color:#75715e">// producer_comsumer.c
</span><span style="color:#75715e"></span>     <span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;buffer.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>     <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>     <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
     <span style="color:#75715e">#define NP 2   </span><span style="color:#75715e">// Number of producers
</span><span style="color:#75715e"></span>     <span style="color:#75715e">#define NC 3   </span><span style="color:#75715e">// Number of comsumers
</span><span style="color:#75715e"></span>
     <span style="color:#66d9ef">struct</span> Arg {   <span style="color:#75715e">// Arguments for the thread functions
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> id;
        Buffer <span style="color:#f92672">*</span>buffer;
    };

    _Noreturn <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">errorExit</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg) {
        fprintf(stderr, <span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg);
        exit(<span style="color:#ae81ff">0xff</span>);
    }

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
        printf(<span style="color:#e6db74">&#34;producer-Consumer Demo</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>);
        Buffer buf; <span style="color:#75715e">// Create a buffer fo five products
</span><span style="color:#75715e"></span>        bufInit(<span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">5</span>);

        thrd_t prod[NP], cons[NC];  <span style="color:#75715e">// The threads and their arguments
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> Arg proArg[NP], consArg[NC];
        <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NP; <span style="color:#f92672">++</span>i) { <span style="color:#75715e">// Start the producers
</span><span style="color:#75715e"></span>            prodArg[i].id <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
            prodArg[i].bufPtr <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>buf;
            <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>prod[<span style="color:#ae81ff">1</span>], producer, <span style="color:#f92672">&amp;</span>prodArg[i]) <span style="color:#f92672">!=</span> thrd_success) {
                errorExit(<span style="color:#e6db74">&#34;Thread error.&#34;</span>);
            }
        }

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NC; <span style="color:#f92672">++</span>i ) { <span style="color:#75715e">// Start the consumers.
</span><span style="color:#75715e"></span>            consArg[i].id <span style="color:#f92672">=</span> i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, consArg[i].bufPtr <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>buf;             <span style="color:#66d9ef">if</span> (thrd_create(<span style="color:#f92672">&amp;</span>cons[i], consumer, <span style="color:#f92672">&amp;</span>consArg[i] ) <span style="color:#f92672">!=</span> thrd_success) {
                errorExit(<span style="color:#e6db74">&#34;Thread error.&#34;</span>);
            }
        }

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NP; <span style="color:#f92672">++</span>i) {
            thrd_join(prod[i], <span style="color:#f92672">&amp;</span>res);
            printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Producer %d ended with result %d.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, prodArg[i].id, res);
        }

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NC; <span style="color:#f92672">++</span>i) {
            thrd_join(cons[i], <span style="color:#f92672">&amp;</span>res);
            printf(<span style="color:#e6db74">&#34;Consumer %d ended with result %d.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, consArg[i].id, res);
        }

        bufDestroy(<span style="color:#f92672">&amp;</span>buf);
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">producer</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {   <span style="color:#75715e">// The producers&#39; thread function
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> Arg <span style="color:#f92672">*</span>argPtr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> Arg <span style="color:#f92672">*</span>) arg;
        <span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> argPtr<span style="color:#f92672">-&gt;</span>id;
        Buffer <span style="color:#f92672">*</span>bufPtr <span style="color:#f92672">=</span> argPtr<span style="color:#f92672">-&gt;</span>bufPtr;

        <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; <span style="color:#f92672">++</span>i) {
            <span style="color:#66d9ef">int</span> data <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> id <span style="color:#f92672">+</span> i;
            <span style="color:#66d9ef">if</span> (bufPut(bufPtr, data)) {
                printf(<span style="color:#e6db74">&#34;Producer %d produced %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, id, data);
                <span style="color:#f92672">++</span>count;
            } <span style="color:#66d9ef">else</span> {
                fprintf(stderr, <span style="color:#e6db74">&#34;Producer %d: error storing %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, id, data);
            }
        }

        <span style="color:#66d9ef">return</span> count;
    }

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">consumer</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg) {   <span style="color:#75715e">// The consumers&#39; thread function.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">struct</span> Arg <span style="color:#f92672">*</span>argPtr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> Arg <span style="color:#f92672">*</span>) arg;
        <span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> argPtr<span style="color:#f92672">-&gt;</span>id;
        Buffer <span style="color:#f92672">*</span>bufPtr <span style="color:#f92672">=</span> argPtr<span style="color:#f92672">-&gt;</span>bufPtr;

        <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">while</span> (bufGet(bufPtr, <span style="color:#f92672">&amp;</span>data, <span style="color:#ae81ff">2</span>)) {
            <span style="color:#f92672">++</span>count;
            printf(<span style="color:#e6db74">&#34;Consumer %d consumed %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, id, data);
        }

        <span style="color:#66d9ef">return</span> count;
    }
</code></pre></div>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/c">#C</a>
        
            <a class="tag" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#学习笔记</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="0xd1ef@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="https://twitter.com/luyangx" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://weibo.com/0xd1ef" target="_blank" rel="noopener" title="Weibo">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M11.7643305,23.68043 C16.3966564,23.2245381 19.9124334,20.3848721 19.6072176,17.3404411 C19.3097287,14.2998735 15.3071519,12.2019978 10.6709625,12.6617533 C6.03863666,13.1215087 2.52285972,15.9573112 2.82421203,19.0017422 C3.12556434,22.0423098 7.12814116,24.1401855 11.7643305,23.68043 Z M21.0328458,13.5774007 C22.6400581,14.075791 24.4288545,15.2812003 24.424991,17.4061204 C24.424991,20.9180339 19.3599541,25.3417312 11.7450131,25.3417312 C5.93818589,25.3417312 -2.23820962e-13,22.5252462 -2.23820962e-13,17.8967838 C-2.23820962e-13,15.4743748 1.53380598,12.6733438 4.17257044,10.0345793 C7.69993785,6.50721189 11.8145559,4.89999957 13.3599524,6.44925952 C14.0399268,7.13309745 14.1056062,8.31146225 13.6690317,9.72163652 C13.4372222,10.4286554 14.3335521,10.0384428 14.3335521,10.0384428 C17.1848086,8.84462403 19.6728969,8.77508119 20.5808173,10.0732142 C21.0676172,10.7686426 21.0212553,11.7383789 20.5730903,12.8626548 C20.3683253,13.3803626 20.6387697,13.4576325 21.0328458,13.5774007 Z M26.0901557,5.1047646 C27.9291775,7.14082443 28.4275678,9.91867457 27.6394156,12.3488105 C27.6394156,12.3488105 27.6394156,12.352674 27.6394156,12.352674 C27.4578316,12.9128802 26.8551269,13.2219595 26.2910572,13.0403754 C25.7269875,12.8587913 25.4179082,12.2560867 25.5994923,11.692017 C26.1596985,9.96117297 25.8042573,7.98692899 24.4983973,6.53811982 C23.1925373,5.08931064 21.2646553,4.5368314 19.4835858,4.91545354 C18.9040622,5.03908525 18.336129,4.67205359 18.2124973,4.09252992 C18.0888655,3.51686974 18.4558972,2.94507305 19.0354209,2.82144134 C21.5389631,2.28827956 24.2511339,3.06484128 26.0901557,5.1047646 Z M23.2659437,7.65466876 C24.1622736,8.64758598 24.4018101,9.99980788 24.0193244,11.1858997 C23.8609213,11.6726995 23.3432135,11.9354169 22.8564136,11.7808773 C22.3696137,11.6224742 22.1068963,11.1009029 22.261436,10.6179665 C22.450747,10.0384428 22.3309788,9.37778581 21.8944043,8.89098592 C21.4578298,8.40804953 20.8087633,8.22260195 20.2137857,8.35009716 C19.7192588,8.45827491 19.2285954,8.14146864 19.1204177,7.64307828 C19.0161034,7.14468793 19.3329097,6.65016106 19.8313,6.5458468 C21.0482998,6.2831294 22.3696137,6.66175153 23.2659437,7.65466876 Z M12.0193209,18.1710916 C12.1738606,17.8890568 12.0734098,17.576114 11.7952385,17.4756632 C11.5209306,17.3674855 11.1770799,17.4988442 11.0148133,17.7692886 C10.8564101,18.039733 10.9414069,18.3526757 11.2195783,18.464717 C11.4977496,18.5806217 11.8570543,18.449263 12.0193209,18.1710916 Z M10.5396038,20.0642023 C10.9800418,19.3417295 10.7482324,18.5188059 10.021896,18.2058631 C9.30328667,17.9045108 8.3760488,18.2135901 7.93174732,18.9090185 C7.48358235,19.6083104 7.69607436,20.438961 8.40695673,20.7634942 C9.12942957,21.091891 10.0914389,20.7789482 10.5396038,20.0642023 Z M12.224086,15.0030289 C14.5074092,15.5941431 15.6741836,17.7461076 14.7392187,19.8401198 C13.7926634,21.9766304 11.0727656,23.1202238 8.76239791,22.37457 C6.53702702,21.6559607 5.59047169,19.4537707 6.56793494,17.4717998 C7.52608075,15.5284637 10.0180325,14.4273687 12.224086,15.0030289 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://luyang87.gitee.io/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>