<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Elasticsearch 学习记录 | 扬</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://www.luyang.ink/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">扬</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">About</a>
  
    <a class="color-link nav-link" href="/tags/">Tags</a>
  
  <a class="color-link nav-link" href="https://www.luyang.ink/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="0xd1ef@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="https://twitter.com/luyangx" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://weibo.com/0xd1ef" target="_blank" rel="noopener" title="Weibo">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M11.7643305,23.68043 C16.3966564,23.2245381 19.9124334,20.3848721 19.6072176,17.3404411 C19.3097287,14.2998735 15.3071519,12.2019978 10.6709625,12.6617533 C6.03863666,13.1215087 2.52285972,15.9573112 2.82421203,19.0017422 C3.12556434,22.0423098 7.12814116,24.1401855 11.7643305,23.68043 Z M21.0328458,13.5774007 C22.6400581,14.075791 24.4288545,15.2812003 24.424991,17.4061204 C24.424991,20.9180339 19.3599541,25.3417312 11.7450131,25.3417312 C5.93818589,25.3417312 -2.23820962e-13,22.5252462 -2.23820962e-13,17.8967838 C-2.23820962e-13,15.4743748 1.53380598,12.6733438 4.17257044,10.0345793 C7.69993785,6.50721189 11.8145559,4.89999957 13.3599524,6.44925952 C14.0399268,7.13309745 14.1056062,8.31146225 13.6690317,9.72163652 C13.4372222,10.4286554 14.3335521,10.0384428 14.3335521,10.0384428 C17.1848086,8.84462403 19.6728969,8.77508119 20.5808173,10.0732142 C21.0676172,10.7686426 21.0212553,11.7383789 20.5730903,12.8626548 C20.3683253,13.3803626 20.6387697,13.4576325 21.0328458,13.5774007 Z M26.0901557,5.1047646 C27.9291775,7.14082443 28.4275678,9.91867457 27.6394156,12.3488105 C27.6394156,12.3488105 27.6394156,12.352674 27.6394156,12.352674 C27.4578316,12.9128802 26.8551269,13.2219595 26.2910572,13.0403754 C25.7269875,12.8587913 25.4179082,12.2560867 25.5994923,11.692017 C26.1596985,9.96117297 25.8042573,7.98692899 24.4983973,6.53811982 C23.1925373,5.08931064 21.2646553,4.5368314 19.4835858,4.91545354 C18.9040622,5.03908525 18.336129,4.67205359 18.2124973,4.09252992 C18.0888655,3.51686974 18.4558972,2.94507305 19.0354209,2.82144134 C21.5389631,2.28827956 24.2511339,3.06484128 26.0901557,5.1047646 Z M23.2659437,7.65466876 C24.1622736,8.64758598 24.4018101,9.99980788 24.0193244,11.1858997 C23.8609213,11.6726995 23.3432135,11.9354169 22.8564136,11.7808773 C22.3696137,11.6224742 22.1068963,11.1009029 22.261436,10.6179665 C22.450747,10.0384428 22.3309788,9.37778581 21.8944043,8.89098592 C21.4578298,8.40804953 20.8087633,8.22260195 20.2137857,8.35009716 C19.7192588,8.45827491 19.2285954,8.14146864 19.1204177,7.64307828 C19.0161034,7.14468793 19.3329097,6.65016106 19.8313,6.5458468 C21.0482998,6.2831294 22.3696137,6.66175153 23.2659437,7.65466876 Z M12.0193209,18.1710916 C12.1738606,17.8890568 12.0734098,17.576114 11.7952385,17.4756632 C11.5209306,17.3674855 11.1770799,17.4988442 11.0148133,17.7692886 C10.8564101,18.039733 10.9414069,18.3526757 11.2195783,18.464717 C11.4977496,18.5806217 11.8570543,18.449263 12.0193209,18.1710916 Z M10.5396038,20.0642023 C10.9800418,19.3417295 10.7482324,18.5188059 10.021896,18.2058631 C9.30328667,17.9045108 8.3760488,18.2135901 7.93174732,18.9090185 C7.48358235,19.6083104 7.69607436,20.438961 8.40695673,20.7634942 C9.12942957,21.091891 10.0914389,20.7789482 10.5396038,20.0642023 Z M12.224086,15.0030289 C14.5074092,15.5941431 15.6741836,17.7461076 14.7392187,19.8401198 C13.7926634,21.9766304 11.0727656,23.1202238 8.76239791,22.37457 C6.53702702,21.6559607 5.59047169,19.4537707 6.56793494,17.4717998 C7.52608075,15.5284637 10.0180325,14.4273687 12.224086,15.0030289 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/luyangx" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://www.luyang.ink/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">Elasticsearch 学习记录</h1>
    
    <time>November 28, 2016</time>
    
    <div>
        <p>
        <p>公司最近在做一个政府用车的项目, 其中订单搜索这块用到了 Elasticsearch, 同时公司里的把脉平台也使用了 Elasticsearch, 学习记录一下.</p>
<p>Elasticsearch 已经是全球首选的全文搜索引擎了, 它可以快速的存储, 搜索和分析海量数据. 其底层是开源库 Lucene, Elasticsearch 对其进行了封装, 提供了 RESTful API 的操作接口.</p>
<h2 id="基本概念">基本概念</h2>
<h3 id="index-索引">Index 索引</h3>
<p>Elasticsearch 把数据存放在索引中, 相当于关系型数据库中的 database</p>
<p>创建索引 &ldquo;website&rdquo;, 类型&quot;blog&rdquo;, ID&quot;123&rdquo; 的内容, 如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">PUT /website/blog/123
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;title&#34;</span>: <span style="color:#e6db74">&#34;My first blog entry&#34;</span>,
  <span style="color:#e6db74">&#34;text&#34;</span>:  <span style="color:#e6db74">&#34;Just trying this out...&#34;</span>,
  <span style="color:#e6db74">&#34;date&#34;</span>:  <span style="color:#e6db74">&#34;2014/01/01&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Elasticsearch 响应:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
   <span style="color:#f92672">&#34;_index&#34;</span>:    <span style="color:#e6db74">&#34;website&#34;</span>,
   <span style="color:#f92672">&#34;_type&#34;</span>:     <span style="color:#e6db74">&#34;blog&#34;</span>,
   <span style="color:#f92672">&#34;_id&#34;</span>:       <span style="color:#e6db74">&#34;123&#34;</span>,
   <span style="color:#f92672">&#34;_version&#34;</span>:  <span style="color:#ae81ff">1</span>,
   <span style="color:#f92672">&#34;created&#34;</span>:   <span style="color:#66d9ef">true</span>
}
</code></pre></div><p>每个文档中都有一个版本号, 每当文档变化时(包括删除)都会使 <code>_version</code> 自增.</p>
<p>如果新增时没有指定ID, Elasticsearch 可以自动生成.</p>
<h3 id="document-文档">Document 文档</h3>
<p>Index 中单条的记录, 使用 JSON 表示</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;name&#34;</span>:         <span style="color:#e6db74">&#34;John Smith&#34;</span>,
    <span style="color:#f92672">&#34;age&#34;</span>:          <span style="color:#ae81ff">42</span>,
    <span style="color:#f92672">&#34;confirmed&#34;</span>:    <span style="color:#66d9ef">true</span>,
    <span style="color:#f92672">&#34;join_date&#34;</span>:    <span style="color:#e6db74">&#34;2014-06-01&#34;</span>,
    <span style="color:#f92672">&#34;home&#34;</span>: {
        <span style="color:#f92672">&#34;lat&#34;</span>:      <span style="color:#ae81ff">51.5</span>,
        <span style="color:#f92672">&#34;lon&#34;</span>:      <span style="color:#ae81ff">0.1</span>
    },
    <span style="color:#f92672">&#34;accounts&#34;</span>: [
        {
            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;facebook&#34;</span>,
            <span style="color:#f92672">&#34;id&#34;</span>:   <span style="color:#e6db74">&#34;johnsmith&#34;</span>
        },
        {
            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;twitter&#34;</span>,
            <span style="color:#f92672">&#34;id&#34;</span>:   <span style="color:#e6db74">&#34;johnsmith&#34;</span>
        }
    ]
}
</code></pre></div><h4 id="文档元数据">文档元数据</h4>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>_index</td>
<td>文档存放的 index</td>
</tr>
<tr>
<td>_type</td>
<td>文档代表的类型 type</td>
</tr>
<tr>
<td>_id</td>
<td>文档唯一标识</td>
</tr>
</tbody>
</table>
<p>文档通过 <code>_index, _type, _id</code> 确定唯一性</p>
<h3 id="type-文档类型">Type 文档类型</h3>
<p>根据数据的不同, 对 Document 分组, 这种分组叫做 Type, 相当于关系数据库中的 table</p>
<h3 id="node-节点-cluster-集群">Node 节点, Cluster 集群</h3>
<p>单个 Elasticsearch 实例成为1个节点, 一组节点构成一个集群.</p>
<h2 id="副本分片">副本分片</h2>
<p>副本分片的目的就是为了故障转移, 通过增加副本分片可以横向扩展, 也可以负载均衡.</p>
<h2 id="本地操作">本地操作</h2>
<h3 id="创建">创建</h3>
<p><code>_index, _type, _id</code> 三者唯一确定一个文档, 创建时可以指定ID或是让 Elasticsearch 自动生成, 如果文档已经存在, 将响应 409 Conflict</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">// 创建 Index
$ curl -X POST <span style="color:#e6db74">&#39;localhost:9200/cms&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;acknowledged&#34;</span>: true,
  <span style="color:#e6db74">&#34;shards_acknowledged&#34;</span>: true,
  <span style="color:#e6db74">&#34;index&#34;</span>: <span style="color:#e6db74">&#34;cms&#34;</span>
<span style="color:#f92672">}</span>

// 创建 Document
$ curl -X POST <span style="color:#e6db74">&#39;localhost:9200/cms/user/1&#39;</span> -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;张三&#34;,&#34;age&#34;:23,&#34;gender&#34;:&#34;男&#34;}&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;_index&#34;</span>: <span style="color:#e6db74">&#34;cms&#34;</span>,
  <span style="color:#e6db74">&#34;_type&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>,
  <span style="color:#e6db74">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
  <span style="color:#e6db74">&#34;_version&#34;</span>: 1,
  <span style="color:#e6db74">&#34;result&#34;</span>: <span style="color:#e6db74">&#34;created&#34;</span>,
  <span style="color:#e6db74">&#34;_shards&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span>: 2,
    <span style="color:#e6db74">&#34;successful&#34;</span>: 1,
    <span style="color:#e6db74">&#34;failed&#34;</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;_seq_no&#34;</span>: 0,
  <span style="color:#e6db74">&#34;_primary_term&#34;</span>: <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="更新">更新</h3>
<p>文档在 Elasticsearch 是不可修改的, 这里说的修改其实是重建索引(reindex)或替换掉它</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">// 更新 user/1 的 age
$ curl -X PUT <span style="color:#e6db74">&#39;localhost:9200/cms/user/1&#39;</span> -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;张三&#34;,&#34;age&#34;:25,&#34;gender&#34;:&#34;男&#34;}&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;_index&#34;</span>: <span style="color:#e6db74">&#34;cms&#34;</span>,
  <span style="color:#e6db74">&#34;_type&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>,
  <span style="color:#e6db74">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
  <span style="color:#e6db74">&#34;_version&#34;</span>: 2,
  <span style="color:#e6db74">&#34;result&#34;</span>: <span style="color:#e6db74">&#34;updated&#34;</span>,
  <span style="color:#e6db74">&#34;_shards&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span>: 2,
    <span style="color:#e6db74">&#34;successful&#34;</span>: 1,
    <span style="color:#e6db74">&#34;failed&#34;</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;_seq_no&#34;</span>: 1,
  <span style="color:#e6db74">&#34;_primary_term&#34;</span>: <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Elasticsearch 内部会将旧的文档标记为删除, 并添加一个完整的新文档.</p>
<h3 id="删除">删除</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl -X DELETE <span style="color:#e6db74">&#39;localhost:9200/cms/user/1&#39;</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;_index&#34;</span>: <span style="color:#e6db74">&#34;cms&#34;</span>,
  <span style="color:#e6db74">&#34;_type&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>,
  <span style="color:#e6db74">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
  <span style="color:#e6db74">&#34;_version&#34;</span>: 3,
  <span style="color:#e6db74">&#34;result&#34;</span>: <span style="color:#e6db74">&#34;deleted&#34;</span>,
  <span style="color:#e6db74">&#34;_shards&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span>: 2,
    <span style="color:#e6db74">&#34;successful&#34;</span>: 1,
    <span style="color:#e6db74">&#34;failed&#34;</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;_seq_no&#34;</span>: 2,
  <span style="color:#e6db74">&#34;_primary_term&#34;</span>: <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="集群">集群</h2>
<p>索引一个文档, Elasticsearch 会用下面的公式计算出分片</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">shard <span style="color:#f92672">=</span> hash<span style="color:#f92672">(</span>routing<span style="color:#f92672">)</span> &amp; number_of_primary_shards
</code></pre></div><ul>
<li>routing: 任意字符串, 默认 <code>_id</code>, 也可自定义</li>
<li>number_of_primary_shards: 主分片数量</li>
<li>shard: 分片, 范围 0 到 number_of_primary_shards - 1</li>
</ul>
<h2 id="集群数据操作">集群数据操作</h2>
<p>有3个节点的集群, 有2个主分片, 每个主分片各有2各复制分片:</p>
<p><img src="/images/es-cluster.png" alt=""></p>
<p>相同的分片不会出现在同1个节点上, 集群中任意节点都可以处理请求, 每个节点都知道任意文档所在节点.</p>
<h3 id="新建索引删除">新建/索引/删除</h3>
<p>新建/索引/删除请求都是写操作, 必须在主分片上成功完成才能复制到相关的复制分片上.</p>
<p><img src="/images/es-cluster-write.png" alt=""></p>
<ol>
<li>Client 发给 NODE1 新建/索引/删除请求</li>
<li>节点使用文档的 <code>_id</code> 确定文档属于分片0, 将请求转发到分片0所在的 NODE3 节点上</li>
<li>NODE3 在主分片上执行写请求, 如果成功, 转发写请求到位于 NODE1 和 NODE2 的复制节点上, 所有复制分片所在节点回复成功, NODE3 反馈 Client 写请求成功.</li>
</ol>
<p>复制默认的值是同步的(sync), 主分片需要等待所有复制分片的成功响应后才返回.</p>
<h3 id="检索">检索</h3>
<p>文档可以从主分片或复制分片中被检索</p>
<p><img src="/images/es-cluster-query.png" alt=""></p>
<ol>
<li>Client 向 NODE1 发送 get 请求</li>
<li>节点使用文档的 <code>_id</code> 确定文档属于分片0, 分片0对应复制分片在3个节点上都存在. 将请求转发给 NODE2</li>
<li>NODE2 将文档返回给 NODE1, NODE1 将文档返回给 Client</li>
</ol>
<h2 id="倒排索引-inverted-index">倒排索引 inverted index</h2>
<p>Elasticsearch 用倒排索引(inverted index)来做全文搜索, 将文档分词后, 记录词出现的文档.</p>
<h2 id="数据搜索">数据搜索</h2>
<h3 id="返回所有记录">返回所有记录</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl <span style="color:#960050;background-color:#1e0010">&#39;</span>localhost:9200/accounts/person/
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;took&#34;</span>: 227, // 耗时
  <span style="color:#e6db74">&#34;timed_out&#34;</span>: false, // 是否超时
  <span style="color:#e6db74">&#34;_shards&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;total&#34;</span>: 1,
    <span style="color:#e6db74">&#34;successful&#34;</span>: 1,
    <span style="color:#e6db74">&#34;skipped&#34;</span>: 0,
    <span style="color:#e6db74">&#34;failed&#34;</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#f92672">}</span>,
  <span style="color:#e6db74">&#34;hits&#34;</span>: <span style="color:#f92672">{</span> // 命中记录
    <span style="color:#e6db74">&#34;total&#34;</span>: <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;value&#34;</span>: 3, // 总数
      <span style="color:#e6db74">&#34;relation&#34;</span>: <span style="color:#e6db74">&#34;eq&#34;</span>
    <span style="color:#f92672">}</span>,
    <span style="color:#e6db74">&#34;max_score&#34;</span>: 1.0, // 最高匹配成都
    <span style="color:#e6db74">&#34;hits&#34;</span>: <span style="color:#f92672">[</span>
      <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;_index&#34;</span>: <span style="color:#e6db74">&#34;cms&#34;</span>,
        <span style="color:#e6db74">&#34;_type&#34;</span>: <span style="color:#e6db74">&#34;user&#34;</span>,
        <span style="color:#e6db74">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
        <span style="color:#e6db74">&#34;_score&#34;</span>: 1.0,
        <span style="color:#e6db74">&#34;_source&#34;</span>: <span style="color:#f92672">{</span>
          <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;张燕&#34;</span>,
          <span style="color:#e6db74">&#34;age&#34;</span>: 21,
          <span style="color:#e6db74">&#34;gender&#34;</span>: <span style="color:#e6db74">&#34;女&#34;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>,
      ...
    <span style="color:#f92672">]</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/kafka">#Kafka</a>
        
            <a class="tag" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#学习笔记</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="0xd1ef@gmail.com" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    
    <a class="social-icon" href="https://twitter.com/luyangx" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://weibo.com/0xd1ef" target="_blank" rel="noopener" title="Weibo">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M11.7643305,23.68043 C16.3966564,23.2245381 19.9124334,20.3848721 19.6072176,17.3404411 C19.3097287,14.2998735 15.3071519,12.2019978 10.6709625,12.6617533 C6.03863666,13.1215087 2.52285972,15.9573112 2.82421203,19.0017422 C3.12556434,22.0423098 7.12814116,24.1401855 11.7643305,23.68043 Z M21.0328458,13.5774007 C22.6400581,14.075791 24.4288545,15.2812003 24.424991,17.4061204 C24.424991,20.9180339 19.3599541,25.3417312 11.7450131,25.3417312 C5.93818589,25.3417312 -2.23820962e-13,22.5252462 -2.23820962e-13,17.8967838 C-2.23820962e-13,15.4743748 1.53380598,12.6733438 4.17257044,10.0345793 C7.69993785,6.50721189 11.8145559,4.89999957 13.3599524,6.44925952 C14.0399268,7.13309745 14.1056062,8.31146225 13.6690317,9.72163652 C13.4372222,10.4286554 14.3335521,10.0384428 14.3335521,10.0384428 C17.1848086,8.84462403 19.6728969,8.77508119 20.5808173,10.0732142 C21.0676172,10.7686426 21.0212553,11.7383789 20.5730903,12.8626548 C20.3683253,13.3803626 20.6387697,13.4576325 21.0328458,13.5774007 Z M26.0901557,5.1047646 C27.9291775,7.14082443 28.4275678,9.91867457 27.6394156,12.3488105 C27.6394156,12.3488105 27.6394156,12.352674 27.6394156,12.352674 C27.4578316,12.9128802 26.8551269,13.2219595 26.2910572,13.0403754 C25.7269875,12.8587913 25.4179082,12.2560867 25.5994923,11.692017 C26.1596985,9.96117297 25.8042573,7.98692899 24.4983973,6.53811982 C23.1925373,5.08931064 21.2646553,4.5368314 19.4835858,4.91545354 C18.9040622,5.03908525 18.336129,4.67205359 18.2124973,4.09252992 C18.0888655,3.51686974 18.4558972,2.94507305 19.0354209,2.82144134 C21.5389631,2.28827956 24.2511339,3.06484128 26.0901557,5.1047646 Z M23.2659437,7.65466876 C24.1622736,8.64758598 24.4018101,9.99980788 24.0193244,11.1858997 C23.8609213,11.6726995 23.3432135,11.9354169 22.8564136,11.7808773 C22.3696137,11.6224742 22.1068963,11.1009029 22.261436,10.6179665 C22.450747,10.0384428 22.3309788,9.37778581 21.8944043,8.89098592 C21.4578298,8.40804953 20.8087633,8.22260195 20.2137857,8.35009716 C19.7192588,8.45827491 19.2285954,8.14146864 19.1204177,7.64307828 C19.0161034,7.14468793 19.3329097,6.65016106 19.8313,6.5458468 C21.0482998,6.2831294 22.3696137,6.66175153 23.2659437,7.65466876 Z M12.0193209,18.1710916 C12.1738606,17.8890568 12.0734098,17.576114 11.7952385,17.4756632 C11.5209306,17.3674855 11.1770799,17.4988442 11.0148133,17.7692886 C10.8564101,18.039733 10.9414069,18.3526757 11.2195783,18.464717 C11.4977496,18.5806217 11.8570543,18.449263 12.0193209,18.1710916 Z M10.5396038,20.0642023 C10.9800418,19.3417295 10.7482324,18.5188059 10.021896,18.2058631 C9.30328667,17.9045108 8.3760488,18.2135901 7.93174732,18.9090185 C7.48358235,19.6083104 7.69607436,20.438961 8.40695673,20.7634942 C9.12942957,21.091891 10.0914389,20.7789482 10.5396038,20.0642023 Z M12.224086,15.0030289 C14.5074092,15.5941431 15.6741836,17.7461076 14.7392187,19.8401198 C13.7926634,21.9766304 11.0727656,23.1202238 8.76239791,22.37457 C6.53702702,21.6559607 5.59047169,19.4537707 6.56793494,17.4717998 C7.52608075,15.5284637 10.0180325,14.4273687 12.224086,15.0030289 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/luyangx" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://www.luyang.ink/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>