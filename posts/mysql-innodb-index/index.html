<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>MySQL 之 InnoDB . 索引 | 扬</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="https://www.luyang.ink/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">扬</a>
    </div>  
</header>

  <div class="nav-menu">
  
  <a class="color-link nav-link" href="https://www.luyang.ink/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="https://www.luyang.ink/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">MySQL 之 InnoDB . 索引</h1>
    
    <time>September 30, 2016</time>
    
    <div>
        <p>
        <p>学习记录 InnoDB 索引相关内容</p>
<h2 id="b-tree">B+ Tree</h2>
<p>B+树时为了磁盘或其他直接存取辅助设备设计的一种平衡查找树. 所有记录节点都是按键值大小顺序存放在同一层叶子节点上, 由各个叶子节点指针进行连接.</p>
<p><img src="/images/innodb-index-bxtree.png" alt=""></p>
<h3 id="b-tree-插入">B+ Tree 插入</h3>
<p>B+ 树在保证插入后叶子节点记录依然顺序, 还需要考虑下面3种情况</p>
<p><img src="/images/innodb-index-bxtree-insert.png" alt=""></p>
<p>可以参考 <a href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">B+树可视化操作-Insert</a></p>
<h3 id="b-tree-删除">B+ Tree 删除</h3>
<p>B+ 树使用填充因子(fill factor)来控制树的删除变化, 50%是最小值, 删除操作同样要保证叶子节点记录依然顺序</p>
<p><img src="/images/innodb-index-bxtree-delete.png" alt=""></p>
<p>可以参考 <a href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">B+树可视化操作-Delete</a></p>
<h2 id="b-tree-索引">B+ Tree 索引</h2>
<p>假设1个page=16KB, 平均每行记录大小=100字节, 则每个page可以保存的记录数量=160, 那么, 高度=2的B+tree可以保存25600行记录(16的2次方), 高度=3可以保存4 096 000行记录(16的3次方), 高度=4可以保存655 360 000行记录(16的4次方), B+tree高度一般在 2-4 层</p>
<h3 id="聚集索引-clustered-index">聚集索引 Clustered Index</h3>
<p>表中数据按主键顺序存放, 每张表只有1个聚集索引. 叶子节点保存着数据, 叶子节点是双向链表. 聚集索引是逻辑上连续的, 物理上不一定连续. 对主键排序和范围查找非常快. EXPLAIN 中 key=PRIMARY</p>
<h3 id="二级索引-secondary-index">二级索引 Secondary Index</h3>
<p>每张表可以有多个二级索引. 叶子节点不包含行记录的全部数据, 除了包含主键外, 还包含1个书签(bookmark). 该书签用来告诉InnoDB哪里可以找到与索引相关的数据, 与聚集索引关系如下图</p>
<p><img src="/images/innodb-index-relation.png" alt=""></p>
<p>高度=3的二级索引, 查找数据会进行3次二级索引比对找到指定主键, 再在高度=3的聚集索引中进行3次比对找到数据所在的page, 一共需要6次逻辑IO</p>
<h2 id="cardinality-值">Cardinality 值</h2>
<p>Cardinality 标识索引中不重复记录数的预估值. 可以根据此值尽可能接近1来评估索引是否是高选择性.</p>
<p>Cardinality 是预估值, 不是准确的. InnoDB更新其值策略为:</p>
<ul>
<li>表中 1/16 的数据已发生变化</li>
<li>stat_modified_counter &gt; 2 000 000 000</li>
</ul>
<p>Cardinality 统计和更新操作过程</p>
<ol>
<li>取 B+树 叶子节点的数量, 记为A</li>
<li>随机取 B+树 索引中的8个叶子节点. 统计每个不同记录的个数, 记为P1,P2,&hellip;P8</li>
<li>根据采样信息给出预估值 Cardinality=(P1+P2+&hellip;+P3)*A/8</li>
</ol>
<h2 id="b-tree-索引使用">B+ Tree 索引使用</h2>
<h3 id="联合索引">联合索引</h3>
<p>多个列进行索引</p>
<p><img src="/images/innodb-table-bxtree-use1.png" alt=""></p>
<h3 id="覆盖索引">覆盖索引</h3>
<p>从二级索引中可以得到查询记录, 不需要再查询聚集索引</p>
<p>如果有联合索引(a, b), 需要统计数据</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">FROM</span> orders <span style="color:#66d9ef">WHERE</span> b<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">10</span> <span style="color:#66d9ef">and</span> b<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">100</span>;
</code></pre></div><p>对应统计数据优化器会选择使用该索引进行统计</p>
<h3 id="index-condition-pushdown-icp-优化">Index Condition Pushdown ICP 优化</h3>
<p>在取出索引的同时, 判断是否可以进行WHERE条件过滤掉多余数据, 而不是根据索引取出数据后再进行WHERE过滤, 大大减少上层对记录的fetch, 提高数据库性能.</p>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/mysql">#MySQL</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="https://www.luyang.ink/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>